# PawGate Python - Release Workflow
# Creates GitHub releases with Windows executable on version tags
#
# Triggers:
#   - Tags: v*.*.* (e.g., v1.0.0, v2.1.0-beta)
#   - Manual: workflow_dispatch
#
# Usage:
#   git tag v1.0.0 && git push origin v1.0.0

name: Python Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (e.g., v1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ github.event.inputs.tag }}"
          } else {
            $tag = $env:GITHUB_REF -replace 'refs/tags/', ''
          }
          $ver = $tag -replace '^v', ''
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Executable
        run: pyinstaller --clean PawGate.spec

      - name: Create Release Package
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"

          # Create release directory
          New-Item -ItemType Directory -Path "release" -Force

          # Copy executable
          Copy-Item "dist/PawGate.exe" "release/PawGate.exe"

          # Generate SHA256 checksum
          $hash = (Get-FileHash "release/PawGate.exe" -Algorithm SHA256).Hash
          "$hash  PawGate.exe" | Out-File "release/SHA256SUMS.txt" -Encoding ascii

          # Create ZIP with version
          Compress-Archive -Path "release/*" -DestinationPath "PawGate-v$ver-python-win64.zip"

          # Show results
          Write-Host "Package contents:"
          Get-ChildItem release/
          Write-Host "`nZIP created: PawGate-v$ver-python-win64.zip"
          Write-Host "SHA256: $hash"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "PawGate ${{ steps.version.outputs.version }} (Python)"
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, '-') }}
          body: |
            ## PawGate ${{ steps.version.outputs.version }} - Python Edition

            Windows keyboard locker to protect against pets walking on your keyboard.

            ---

            ### Quick Start

            1. Download `PawGate-v${{ steps.version.outputs.version }}-python-win64.zip`
            2. Extract and run `PawGate.exe`
            3. Look for the paw icon in your system tray

            ### Default Hotkey

            | Action | Keys |
            |--------|------|
            | **Lock/Unlock** | `Ctrl + B` |

            ### Features

            - Single hotkey toggle for lock/unlock
            - Semi-transparent overlay when locked
            - Blocks all keys including numpad, function keys, media keys
            - System tray icon with settings menu
            - Configurable hotkey, opacity, and overlay color

            ### System Requirements

            - Windows 10/11 (64-bit)
            - No installation required - portable executable

            ### Verification

            Verify download integrity with SHA256 checksum in `SHA256SUMS.txt`

            ---

            > **Note**: Windows may show a SmartScreen warning for unsigned executables.
            > This is normal for open-source software without code signing certificates.

          files: |
            PawGate-v${{ steps.version.outputs.version }}-python-win64.zip
          fail_on_unmatched_files: true
