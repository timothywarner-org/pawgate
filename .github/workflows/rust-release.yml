# PawGate Rust - Release Workflow
# Creates GitHub releases with Windows executable on version tags
#
# Triggers:
#   - Tags: rust-v*.*.* (e.g., rust-v1.0.0, rust-v2.1.0-beta)
#   - Manual: workflow_dispatch
#
# Usage:
#   git tag rust-v1.0.0 && git push origin rust-v1.0.0

name: Rust Release

on:
  push:
    tags:
      - 'rust-v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (e.g., rust-v1.0.0)'
        required: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ github.event.inputs.tag }}"
          } else {
            $tag = $env:GITHUB_REF -replace 'refs/tags/', ''
          }
          $ver = $tag -replace '^rust-v', ''
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: pawgate-rs

      - name: Build Release
        working-directory: pawgate-rs
        run: cargo build --release

      - name: Run Tests
        working-directory: pawgate-rs
        run: cargo test --release

      - name: Create Release Package
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"

          # Create release directory
          New-Item -ItemType Directory -Path "release" -Force

          # Copy executable (rename to PawGate.exe)
          Copy-Item "pawgate-rs/target/release/pawgate.exe" "release/PawGate.exe"

          # Generate SHA256 checksum
          $hash = (Get-FileHash "release/PawGate.exe" -Algorithm SHA256).Hash
          "$hash  PawGate.exe" | Out-File "release/SHA256SUMS.txt" -Encoding ascii

          # Get binary size
          $size = [math]::Round((Get-Item "release/PawGate.exe").Length / 1MB, 2)
          Write-Host "Binary size: $size MB"

          # Create ZIP
          Compress-Archive -Path "release/*" -DestinationPath "PawGate-v$ver-rust-win64.zip"

          # Show results
          Write-Host "`nPackage contents:"
          Get-ChildItem release/
          Write-Host "`nZIP created: PawGate-v$ver-rust-win64.zip"
          Write-Host "SHA256: $hash"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "PawGate ${{ steps.version.outputs.version }} (Rust)"
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, '-') }}
          body: |
            ## PawGate ${{ steps.version.outputs.version }} - Rust Edition

            Fast, lightweight Windows keyboard locker written in Rust.
            Protects against pets walking on your keyboard.

            ---

            ### Quick Start

            1. Download `PawGate-v${{ steps.version.outputs.version }}-rust-win64.zip`
            2. Extract and run `PawGate.exe`
            3. Look for the paw icon in your system tray

            ### Default Hotkey

            | Action | Keys |
            |--------|------|
            | **Lock/Unlock** | `Ctrl + B` |

            ### Features

            - **~2-3 MB** standalone executable (no runtime dependencies)
            - **<100ms** startup time
            - **~5 MB** RAM usage
            - Single hotkey toggle for lock/unlock
            - Semi-transparent overlay across all monitors
            - Blocks all keys including numpad, function keys, laptop media keys
            - Native Windows settings dialog
            - Colorblind-friendly icon (blue/orange high contrast)

            ### System Requirements

            - Windows 10/11 (64-bit)
            - No installation required - portable executable
            - No runtime dependencies

            ### Verification

            Verify download integrity with SHA256 checksum in `SHA256SUMS.txt`

            ---

            ### Why Rust Edition?

            | Metric | Python | Rust |
            |--------|--------|------|
            | Binary Size | ~15 MB | ~2-3 MB |
            | Startup Time | ~2s | <100ms |
            | Memory Usage | ~50 MB | ~5 MB |
            | Dependencies | Python runtime | None |

            ---

            > **Note**: Windows may show a SmartScreen warning for unsigned executables.
            > This is normal for open-source software without code signing certificates.

          files: |
            PawGate-v${{ steps.version.outputs.version }}-rust-win64.zip
          fail_on_unmatched_files: true
